<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>

    <script src="js/slippy_map.js" type="text/javascript"></script>
    <style>
        body { margin:0; padding:0;}
        #map2div { position:absolute; top:0; bottom:0; width:100%; overflow: hidden;}
    </style>
</head>
<body>

<div id="map2div" style="position: absolute; width: 100%; height: 100%; z-index: 0; " tabindex="0">
        <canvas id="map2" style="">
            Your browser doesn't support canvas elements.
        </canvas>
    </div>

<script>

    var ConstMaxMapZoom = 18;

    (function () {
        var lastTime = 0;
        var vendors = ['ms', 'moz', 'webkit', 'o'];
        for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
            window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
            window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']
                    || window[vendors[x] + 'CancelRequestAnimationFrame'];
        }

        if (!window.requestAnimationFrame)
            window.requestAnimationFrame = function (callback, element) {
                var currTime = new Date().getTime();
                var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                var id = window.setTimeout(function () {
                            callback(currTime + timeToCall);
                        },
                        timeToCall);
                lastTime = currTime + timeToCall;
                return id;
            };

        if (!window.cancelAnimationFrame)
            window.cancelAnimationFrame = function (id) {
                clearTimeout(id);
            };
    }());

    var MapManager = (function() {

    function MapManager(){

        this.inZoomChange = false;
        this.need_render = true;

        this.oldZoomForCalcZoom = 0;
        this.newZoomForCalcZoom = 0;
        this.startZoomChangeTime = 0;

        this.tileLayerPath = '';

        this.zoom_duration = 0;

        this.server_min_zoom = 10;

        this.zoom_calc_func = this.zoom_functions['easeOutCirc'];


        this.times_of_render = [];
    }

    MapManager.prototype.set_coord = function (options) {
        if (options.x !== undefined)
            smap.map.position.setX(options.x, {animated: false});
        if (options.y !== undefined)
            smap.map.position.setY(options.y, {animated: false});
        if (options.z !== undefined)
            smap.map.position.setZ(options.z, {animated: false});
        this.need_render = true;
    };

    MapManager.prototype.redraw = function(ctx, time, client_time) {
        if (this.inZoomChange) {
            if ((client_time >= this.startZoomChangeTime) &&
                (client_time < (this.startZoomChangeTime + this.zoom_duration))) {
                var zoom_progress = this._zoom_progress(client_time);
                var anim_zoom_progress = this.zoom_calc_func(zoom_progress, client_time - this.startZoomChangeTime, 0, 100, this.zoom_duration);
                this.current_zoom = this.oldZoomForCalcZoom + (anim_zoom_progress / 100.) * (this.newZoomForCalcZoom - this.oldZoomForCalcZoom);
                this.current_zoom = parseFloat(this.current_zoom.toFixed(2))
            }
            else {
                this.current_zoom = this.newZoomForCalcZoom;
                this.onZoomEnd();
            }
            this.set_coord({z: this.current_zoom});
        }
        if (this.need_render) {
            this.need_render = false;
            smap.renderer.refresh();

            var redraw_time = smap.renderer.refreshLastFinish - smap.renderer.refreshLastStart;
            this.times_of_render.push(redraw_time);
            console.log(redraw_time, this.current_zoom);
        }
    };

    // =============================== Map Coords

    MapManager.prototype.getMapCenter = function () {
        var c = smap.center();
        return new Point(c.x, c.y);
    };

    MapManager.prototype.getMapSize = function() {
        return new Point(smap.width(), smap.height());
    };

    MapManager.prototype.getTopLeftCoords = function(zoom) {
        var c = this.getMapCenter();
        var map_size = mulScalVector(this.getMapSize(), 0.5);
        var koeff = Math.pow(2., (ConstMaxMapZoom - zoom));
        return subVector(c, mulScalVector(map_size, koeff));
    };

    // =============================== Zoom

    MapManager.prototype.zoom_functions = {
        easeInOutQuint: function (x, t, b, c, d) {
            if ((t /= d / 2) < 1) return c / 2 * t * t * t * t * t + b;
            return c / 2 * ((t -= 2) * t * t * t * t + 2) + b;
        },
        easeOutQuart: function (x, t, b, c, d) {
            return -c * ((t = t / d - 1) * t * t * t - 1) + b;
        },
        easeOutCirc: function (x, t, b, c, d) { return c * Math.sqrt(1 - (t=t/d-1)*t) + b; },
        easeInSine: function (x, t, b, c, d) {
            return -c * Math.cos(t/d * (Math.PI/2)) + c + b;
        },
    };

    MapManager.prototype._zoom_progress = function (time) {
        return (time - this.startZoomChangeTime) / this.zoom_duration;
    };

    MapManager.prototype.getMaxZoom = function() {
        return ConstMaxMapZoom;
    };

    MapManager.prototype.getMinZoom = function() {
        return this.server_min_zoom;
    };

    MapManager.prototype.getZoomByTick = function(tick) {
        //if (tick <= 0)  return 10;
        //if (tick <= 3) return 10 + tick;
        //if (tick <= 9) return 13 + (tick - 3) * 0.5;
        //if (tick <= 17) return 16 + (tick - 9) * 0.25;
        //return 18;

        if (tick <= 0)  return 10;
        if (tick <= 32) return 10 + tick * 0.25;
        return 18;
    };

    MapManager.prototype.getTickByZoom = function(zoom) {
        //if (zoom <= 10) return 0;
        //if (zoom <= 13) return zoom - 10;
        //if (zoom <= 16) return 3 + (zoom - 13) * 2;
        //if (zoom <= 18) return 9 + (zoom - 16) * 4;
        //return 17;

        if (zoom <= 10) return 0;
        if (zoom <= 18) return 0 + (zoom - 10) * 4;
        return 32;
    };

    MapManager.prototype.getZoom = function() {
        return this.current_zoom;
    };

    MapManager.prototype.setZoom = function(zoom) {
        //console.log('MapManager.prototype.setZoom', zoom, this.server_min_zoom, ConstMaxMapZoom);
        if (zoom < this.server_min_zoom) zoom = this.server_min_zoom;
        if (zoom > ConstMaxMapZoom) zoom = ConstMaxMapZoom;
        if (zoom == this.getZoom()) return;

        this.newZoomForCalcZoom = zoom;
        this.onZoomStart();

    };

    MapManager.prototype.onZoomStart = function () {
        //console.log('MapManager.prototype.onZoomStart', this.getZoom());
        this.inZoomChange = true;
        this.oldZoomForCalcZoom = this.getZoom();
        this.startZoomChangeTime = new Date().getTime();

        var start_tick = this.getTickByZoom(this.oldZoomForCalcZoom);
        var end_tick = this.getTickByZoom(this.newZoomForCalcZoom);
        //this.zoom_duration = Math.min(1000, Math.max(200, Math.abs(start_tick - end_tick) * 200));
        //this.zoom_duration = Math.min(600, Math.max(200, Math.abs(start_tick - end_tick) * 200));
        this.zoom_duration = Math.min(750, Math.max(350, Math.abs(start_tick - end_tick) * 350));
        //this.zoom_duration = 500;

    };

    MapManager.prototype.onZoomEnd = function () {
        this.inZoomChange = false;
        this.startZoomChangeTime = 0;

        console.log("on_Zoom_End ", Math.max.apply(null, this.times_of_render));

        this.times_of_render = [];


        //if (this.getZoom()  > 17)
        //    this.setZoom(15);
        //else
        //    this.setZoom(18);

    };

    return MapManager;
})();

    var mapManager = new MapManager();
    var smap = slippymap({
        div: "map2",
        tileprovider: function (x, y, z) {
            return "http://185.58.205.29/map/" + z + "/" + x + "/" + y + ".jpg";
        },
        zMin: 10,
        zMax: 18,
        lat: 32.93523932687671,
        lon: -113.0391401052475,
        zoom: 18,
    }).init();


    var newZoomForCalcZoom = 0;

    function onMapWheel(event) {
        event = event || window.event;
        var delta = (event.deltaY || event.detail || event.wheelDelta) / 100.;
        var tick = mapManager.getTickByZoom(mapManager.newZoomForCalcZoom);
        var zoom = mapManager.getZoomByTick(tick - delta);
        mapManager.setZoom(zoom);
    }


    document.getElementById('map2div').addEventListener("wheel", onMapWheel);


    function interval_perform(){
        mapManager.redraw(null, null, new Date().getTime());
        return requestAnimationFrame(interval_perform);
    };

    setTimeout(interval_perform, 10);


</script>


</body>
</html>