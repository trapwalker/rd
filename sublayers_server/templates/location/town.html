<div>
    {% raw open(svg_link).read() %}
    <div id="townChatPageWrap" class="townPageWrap" style="display: none">
        <div id="chatTownWrap"></div>
        <div id="visitorListWrap">
            <div id="visitorList">
            </div>
        </div>
    </div>

    <div id="townNucoilPageWrap" class="townPageWrap" style="display: none">
        {% if agent.example.car is not None %}
            {% include nucoil_window.html %}
        {% else %}
            {% include npc_no_car.html %}
        {% end %}
    </div>

    {% if town.example.armorer is not None %}
    <div id="townArmorerPageWrap" class="townPageWrap" style="display: none">
        {% if agent.example.car is not None %}
            {% include armorer_window.html %}
        {% else %}
            {% include npc_no_car.html %}
        {% end %}
    </div>
    {% end %}

    {% if town.example.mechanic is not None %}
    <div id="townMechanicPageWrap" class="townPageWrap" style="display: none">
        {% if agent.example.car is not None %}
            {% include mechanic_window.html %}
        {% else %}
            {% include npc_no_car.html %}
        {% end %}
    </div>
    {% end %}

    {% if town.example.tuner is not None %}
    <div id="townTunerPageWrap" class="townPageWrap" style="display: none">
        {% if agent.example.car is not None %}
            {% include tuner_window.html %}
        {% else %}
            {% include npc_no_car.html %}
        {% end %}
    </div>
    {% end %}

    {% if town.example.trader is not None %}
    <div id="townTraderPageWrap" class="townPageWrap" style="display: none">
        {% if agent.example.car is not None %}
            {% include trader_window.html %}
        {% else %}
            {% include npc_no_car.html %}
        {% end %}
    </div>
    {% end %}

    {% if town.example.hangar is not None %}
    <div id="townHangarPageWrap" class="townPageWrap" style="display: none">
        {% include hangar_window.html %}
    </div>
    {% end %}

    {% if town.example.trainer is not None %}
    <div id="townTrainerPageWrap" class="townPageWrap" style="display: none">
        {% include trainer_window.html %}
    </div>
    {% end %}
</div>
<script>
    function setBtnDisplay(btnIndex, state) {
         $("#btn_" + btnIndex).css("display", state);
         if (state == 'none') {
            $("#btn_" + btnIndex + "_over").css("display", state);
            $("#btn_" + btnIndex + "_select").css("display", state);
         }
    };

    // Открытие зданий
    function openNucoil() {
        $('.townPageWrap').css('display', 'none');
        $('#townNucoilPageWrap').css('display', 'block');
        locationManager.currentNPC = locationManager.nucoil;
        setBtnDisplay(7, "none");
        setBtnDisplay(6, "none");
    }

    function openArmorer() {
        $('.townPageWrap').css('display', 'none');
        $('#townArmorerPageWrap').css('display', 'block');
        locationManager.currentNPC = locationManager.armorer;
        clientManager.sendEnterToNPC('armorer');
        setBtnDisplay(7, "none");
        setBtnDisplay(6, "none");
        setBtnDisplay(8, "block");
        setBtnDisplay(9, "block");
    }

    function openMechanic() {
        $('.townPageWrap').css('display', 'none');
        $('#townMechanicPageWrap').css('display', 'block');
        locationManager.currentNPC = locationManager.mechanic;
        clientManager.sendEnterToNPC('mechanic');
        setBtnDisplay(7, "none");
        setBtnDisplay(6, "none");
        setBtnDisplay(8, "block");
        setBtnDisplay(9, "block");
    }

    function openTuner() {
        $('.townPageWrap').css('display', 'none');
        $('#townTunerPageWrap').css('display', 'block');
        locationManager.currentNPC = locationManager.tuner;
        clientManager.sendEnterToNPC('tuner');
        setBtnDisplay(7, "none");
        setBtnDisplay(6, "none");
        setBtnDisplay(8, "block");
        setBtnDisplay(9, "block");
    }

    function openTrader() {
        $('.townPageWrap').css('display', 'none');
        $('#townTraderPageWrap').css('display', 'block');
        locationManager.currentNPC = locationManager.trader;
        clientManager.sendEnterToNPC('trader');
        setBtnDisplay(7, "none");
        setBtnDisplay(6, "none");
        setBtnDisplay(8, "block");
        setBtnDisplay(9, "block");
    }

    function openHangar() {
        $('.townPageWrap').css('display', 'none');
        $('#townHangarPageWrap').css('display', 'block');
        locationManager.currentNPC = locationManager.hangar;
        setBtnDisplay(7, "none");
        setBtnDisplay(8, "block");
    }

    function openTrainer() {
        $('.townPageWrap').css('display', 'none');
        $('#townTrainerPageWrap').css('display', 'block');
        locationManager.currentNPC = locationManager.trainer;
        setBtnDisplay(7, "none");
        setBtnDisplay(8, "block");
    }

    function openTown() {
        $('.townPageWrap').css('display', 'none');
        $('#layer1').css('display', 'block');
        $('#layer2').css('display', 'block');
        locationManager.currentNPC = null;
        setBtnDisplay(8, "none");
        setBtnDisplay(9, "none");
        setBtnDisplay(6, "block");
        setBtnDisplay(7, "block");
    };

    function openChat() {
        $('.townPageWrap').css('display', 'none');
        $('#townChatPageWrap').css('display', 'block');
        locationManager.currentNPC = null;
        setBtnDisplay(8, "none");
        setBtnDisplay(9, "none");
        setBtnDisplay(6, "none");
        setBtnDisplay(7, "none");
    };

    // Обработчики кнопок-зданий
    {% for i in xrange(10) %}
    $("#img_house{{i}}_off").mouseenter(function() {
        $("#img_house{{i}}_on").css("display", "block");
        $("#img_house{{i}}_off").css("display", "none");
        $("#path_h{{i}}").css("opacity", "0.8");
        $("#path_text_h{{i}}").css("opacity", "0.8");
    });
    $("#img_house{{i}}_on").mouseleave(function() {
        $("#img_house{{i}}_off").css("display", "block");
        $("#img_house{{i}}_on").css("display", "none");
        $("#path_h{{i}}").css("opacity", "0.2");
        $("#path_text_h{{i}}").css("opacity", "0.2");
    });
    $("#path_h{{i}}").mouseenter(function(){
        $("#img_house{{i}}_on").css("display", "block");
        $("#img_house{{i}}_off").css("display", "none");
        $("#path_h{{i}}").css("opacity", "0.8");
        $("#path_text_h{{i}}").css("opacity", "0.8");
    });
    $("#path_h{{i}}").mouseleave(function(){
        $("#img_house{{i}}_off").css("display", "block");
        $("#img_house{{i}}_on").css("display", "none");
        $("#path_h{{i}}").css("opacity", "0.2");
        $("#path_text_h{{i}}").css("opacity", "0.2");
    });

    $("#img_house{{i}}_on").click(function(event) {
        switch (event.target.id) {
            case "img_house1_on":
                openArmorer();
                break;
            case "img_house2_on":
                openMechanic();
                break;
            case "img_house4_on":
                openHangar();
                break;
            case "img_house5_on":
                openNucoil();
                break;
            case "img_house6_on":
                openTuner();
                break;
            case "img_house7_on":
                openTrader();
                break;
            default:
                console.log(event.target.id);
        }
    });
    $("#path_h{{i}}").click(function(event) {
        switch (event.target.id) {
            case "path_h1":
                openArmorer();
                break;
            case "path_h2":
                openMechanic();
                break;
            case "path_h4":
                openHangar();
                break;
            case "path_h5":
                openNucoil();
                break;
            case "path_h6":
                openTuner();
                break;
            case "path_h7":
                openTrader();
                break;
            default:
                console.log(event.target.id);
        }
    });
    {% end %}

    // Кнопки меню
    {% for i in xrange(10) %}
    $("#btn_{{i}}").mouseenter(function() {
        $("#btn_{{i}}_over").css("display", "block");
        $("#btn_{{i}}").css("display", "none");
    });
    $("#btn_{{i}}_over").mouseleave(function() {
        $("#btn_{{i}}_over").css("display", "none");
        $("#btn_{{i}}").css("display", "block");
    });

     $("#btn_{{i}}_select").mouseleave(function() {
        $("#btn_{{i}}_over").css("display", "none");
        $("#btn_{{i}}_select").css("display", "none");
        $("#btn_{{i}}").css("display", "block");
    });

    $("#btn_{{i}}_over").mousedown(function() {
        $("#btn_{{i}}_select").css("display", "block");
        $("#btn_{{i}}_over").css("display", "none");
        $("#btn_{{i}}").css("display", "block");
    });
    $("#btn_{{i}}_select").mouseup(function(event) {
        $("#btn_{{i}}_select").css("display", "none");
        $("#btn_{{i}}_over").css("display", "block");
        $("#btn_{{i}}").css("display", "none");
    });
    {% end %}

    $("#btn_4_select").mouseup(function(event) {
        {% if agent.example.car %}
        clientManager.sendExitFromLocation({{ town.uid }});
        {% else %}
        alert('Вы не можете выйти из города без машинки');
        {% end %}
    });

    $("#btn_3_select").mouseup(function(event) {
        openChat();
    });

    $("#btn_8_select").mouseup(function(event) {
        if (locationManager.currentNPC)
            locationManager.currentNPC.apply();
    });

    $("#btn_9_select").mouseup(function(event) {
        if (locationManager.currentNPC)
            locationManager.currentNPC.cancel();
    });

    $("#btn_2_select").mouseup(function(event) {
        openTown();
    });
</script>