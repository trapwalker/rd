# Торговля #

В игре предполагается наличие следующих видов торговли:
-- глобальный рынок для торговли между игроками и торговли с Городами (доступен в городе);
-- обмен между игроками (доступен на глобальной карте);

## Глобальный рынок.

Глобальный рынок -- сущность (одна на игру), доступная в каждом городе, представляющую собой список торговых лотов (подобие доски с объявлениями о продаже итемов). 

Торговый лот -- сущность-контейнер, состоит из (у каждого Игрока есть список его Торговых лотов, те лоты в которых он указан как хозяин):
	-- ID лота;
	-- информация о хозяине;
	-- итем (или несколько итемов одного типа) выставленный на продажу;
	-- цена единицы итема;
	-- город в котором находится лот;
	-- информация о состоянии лота (в продаже / снят / куплен(высвечивается только у купившего))

При создании торгового лота, итем переходит из инвентаря игрока в сущность Торговый лот, который в свою очередь попадает на 
Глобальный рынок. Хозяин лота может поменять цену лота или снять его с продажи. 

Взаимодействие с Глобальным Рынком: 
-- заехать в город
-- обратиться к Глобальному рынку (окно Глобальный рынок):
	-- вкладка выставления предметов (создание лота), включающее в себя:
			-- инвентарь игрока;
			-- лоты на продажу с возможностью выставить цену для каждого;
-- отображение средней цены по этому городу на такие же Лоты (если в городе нет таких лотов, то средняя цена из других городов с “пометкой”)
-- вкладка своих лотов (имеющие флаг “в продаже”):
	-- механизм редактирования лотов (менять цену);
	-- механизм снятия лота с продажи;
-- вкладка забирания лотов (купленных или снятых):
	-- что-то вроде инвентаря, с кнопкой “Take All”, а при нажатии на отдельный предмет он помещается в свой инвентарь;

После подтверждения выставления лотов выставленные итемы изымаются у игрока и заворачиваются в Торговые лоты. 

Действия над Торговыми лотами:
-- Покупка. Когда осуществляется покупка на глобальном рынке, со счета покупателя списывается сумма равная кол-ву покупаемых итемов умноженную на цену одного итема и зачисляется на счет продавца (не забывая при этом украсть 10-15% налога на сделку):
	-- если покупается весь лот (все итемы), то лот меняет информацию о хозяине и информацию о состоянии лота (куплен);
	-- если покупается часть итемов, то происходит бифуркация торгового лота:
		-- из первоначального лота вычитается кол-во купленных итемов;
		-- в созданный лот перечисляются купленные итемы, копируется информация из лота-родителя, хозяином устанавливается покупатель и устанавливается флаг Куплен.
-- Снятие лота. Продавец может в любой момент снять лот с торгов, лот меняет информацию о состоянии лота (снят);
-- Выставление Лота (Создание Лота). От продавца требуется выбрать предмет и ввести цену предмета. Остальные данные о лоте заполняются автоматически: id, хозяин, город, флаг.


## Обмен ##
Обмен -- процедура непосредственного обмена итемов и денег в живом мире. Осуществляется с помощью Транзакции Обмена.

Транзакция Обмена -- сущность-контейнер, создаваемая по обоюдному согласию двух игроков.

Транзакция Обмена:
	-- Участники;
	-- Списки обмениваемых итемов от каждого участника;
	-- Обмениваемые деньги от каждого участника;
	-- Флаги подтверждения списков обмена (для каждого участника);
	-- Флаги подтверждения транзакции (для каждого участника);

Инициализация Транзакции Обмена:
	-- Любой игрок на глобальной карте будучи на расстоянии <= L (200м) от другого игрока может отправить запрос на открытие Транзакции Обмена
	-- Любой игрок, которому пришёл запрос на открытие Транзакции Обмена может как принять, так и отказаться от неё. 

Процесс Обмена:
	-- Участники из своего инвентаря переносят итемы для обмена в окно транзакции, при этом Итемы физически удаляются из инвентаря и переносятся к инвентари (списки обмена) транзакции;
	-- Участники устанавливают флаги подтверждения списков обмена (в случае изменения списков обмена любой стороной, флаги подтверждения снимаются автоматически)
	-- После установки ОБОИХ флагов подтверждения списков обмена, становятся доступны флаги подтверждения транзакции.
	-- Функция отмены доступна на любом этапе
	
Завершение Транзакции Обмена:
	-- Оба участника поставили флаги подтверждения Транзакции Обмена: обмен состоится
	-- Любой из участников отменил Транзакцию: итемы вернутся к своим хозяевам
	

