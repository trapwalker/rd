<div id="RDSiteWReg" class="page-wrapper switch-page">
    <div class="window-header interlacing buttons-and-headers">Nuke Commander v{{ version }}</div>
    <div class="window-reg-main">
        <div class="window-reg-path">
            <div class="reg-path-up-header-block-header-block">
                <div class="reg-path-up-header-block-back interlacing">
                    <div class="reg-path-up-header-block-header buttons-and-headers">Регистрация</div>
                </div>
            </div>
            <div class="reg-path-up-text-input-block">
                <div class="reg-path-label">E-MAIL></div>
                <input type="email" id="reg_email" autocomplete="off" onclick="RegEmailClick()">
            </div>
            <div class="reg-path-up-text-input-block">
                <div class="reg-path-label">ПАРОЛЬ></div>
                <input type="password" id="reg_password" autocomplete="off" name="password" onclick="RegPasswordClick()">
            </div>
            <div class="window-reg-up-btn-block">
                <div class="reg-path-up-btn window-reg-up-btn buttons-and-headers box-shadow box-shadow-non-active" onclick="RegisterBtnClick();">Зарегистрироваться</div>
            </div>
        </div>
        <div class="window-reg-path right">
            <div class="reg-path-up-header-block-header-block">
                <div class="reg-path-up-header-block-back interlacing">
                    <div class="reg-path-up-header-block-header buttons-and-headers">Авторизация</div>
                </div>
            </div>
            <div class="reg-path-up-text-input-block">
                <div class="reg-path-label">E-MAIL></div>
                <input type="email" id="auth_email" autocomplete="off" onclick="AuthEmailClick()">
            </div>
            <div class="reg-path-up-text-input-block">
                <div class="reg-path-label">ПАРОЛЬ></div>
                <input type="password" id="auth_password" autocomplete="off" onclick="AuthPasswordClick()">
            </div>
            <div class="window-reg-up-btn-block">
                <div class="auth-path-up-btn window-reg-up-btn buttons-and-headers box-shadow box-shadow-non-active" onclick="AuthorisationBtnClick()"><span>Войти</span><span>в систему</span></div>
                <div class="auth-path-up-btn window-reg-up-btn buttons-and-headers box-shadow box-shadow-non-active" onclick="RestorePasswordBtnClick()">Восстановить пароль</div>
            </div>
        </div>
        <div class="window-reg-console-wrap">
            <div id="RDSiteWRegConsole" class="console-block"></div>
        </div>
        <div class="window-reg-footer">
            <div class="reg-btn buttons-and-headers" onclick="VKClick()">1. Вход через VK</div>
            <div class="reg-btn buttons-and-headers" onclick="FBClick()">2. Вход через FB</div>
            <div class="reg-btn buttons-and-headers" onclick="OKClick()">3. Вход через OK</div>
            <div class="reg-btn buttons-and-headers" onclick="GClick()">4. Вход через G+</div>
        </div>
    </div>
</div>

<script>
    var reg_last_input_click;

    function VKClick() {
        if ((reg_last_input_click != 'VKClick') && (consoleWReg)) {
            consoleWReg.add_message('user', 'Подключение через vk.com');
            consoleWReg.add_message('system', 'Ошибка: недоступно в режиме альфа-теста.');
            reg_last_input_click = 'VKClick';
        }
        audioManager.play('error_' + Math.floor(Math.random() * 1.99));
    }

    function FBClick() {
        if ((reg_last_input_click != 'FBClick') && (consoleWReg)) {
            consoleWReg.add_message('user', 'Подключение через facebook.com');
            consoleWReg.add_message('system', 'Ошибка: недоступно в режиме альфа-теста.');
            reg_last_input_click = 'FBClick';
        }
        audioManager.play('error_' + Math.floor(Math.random() * 1.99));
    }

    function OKClick() {
        if ((reg_last_input_click != 'OKClick') && (consoleWReg)) {
            consoleWReg.add_message('user', 'Подключение через ok.ru');
            consoleWReg.add_message('system', 'Ошибка: недоступно в режиме альфа-теста.');
            reg_last_input_click = 'OKClick';
        }
        audioManager.play('error_' + Math.floor(Math.random() * 1.99));
    }

    function GClick() {
        if ((reg_last_input_click != 'GClick') && (consoleWReg)) {
            consoleWReg.add_message('user', 'Подключение через plus.google.com');
            consoleWReg.add_message('system', 'Ошибка: недоступно в режиме альфа-теста.');
            reg_last_input_click = 'GClick';
        }
        audioManager.play('error_' + Math.floor(Math.random() * 1.99));
    }

    function RegEmailClick() {
        if ((reg_last_input_click != 'RegEmailClick') && (consoleWReg)) {
            consoleWReg.add_message('user', 'Запрос на ввод данных в базу системы навигации.');
            consoleWReg.add_message('system',
                    'Успешно.\n\n' +
                    '--------------------------------------------------------------\n' +
                    'Введите адрес своей электронной почты.\n' +
                    '--------------------------------------------------------------');
            reg_last_input_click = 'RegEmailClick';
        }
    }

    function AuthEmailClick() {
        if ((reg_last_input_click != 'AuthEmailClick') && (consoleWReg)) {
            consoleWReg.add_message('user', 'Запрос на ввод данных в базу системы навигации.');
            consoleWReg.add_message('system',
                    'Успешно.\n\n' +
                    '--------------------------------------------------------------\n' +
                    'Введите адрес своей электронной почты.\n' +
                    '--------------------------------------------------------------');
            reg_last_input_click = 'AuthEmailClick';
        }
    }

    function RegPasswordClick() {
        if ((reg_last_input_click != 'RegPasswordClick') && (consoleWReg)) {
            consoleWReg.add_message('user', 'Запрос на ввод данных в базу системы навигации.');
            consoleWReg.add_message('system',
                    'Успешно.\n\n' +
                    '--------------------------------------------------------------\n' +
                    'Создайте новый пароль.\n' +
                    '--------------------------------------------------------------');
            reg_last_input_click = 'RegPasswordClick';
        }
    }

    function AuthPasswordClick() {
        if ((reg_last_input_click != 'AuthPasswordClick') && (consoleWReg)) {
            consoleWReg.add_message('user', 'Запрос на ввод данных в базу системы навигации.');
            consoleWReg.add_message('system',
                    'Успешно.\n\n' +
                    '--------------------------------------------------------------\n' +
                    'Введите свой пароль.\n' +
                    '--------------------------------------------------------------');
            reg_last_input_click = 'AuthPasswordClick';
        }
    }

    function GetUserInfo() {
         $.ajax({
            url: location.protocol + '//' + location.host + '/site_api/get_user_info',
            method: 'POST',
            data: {},
            success: function(data) {
                registration_status = data.user_status;

                if (registration_status == 'register') {
                    var pos_x = '';
                    var pos_y = '';
                    if (data.hasOwnProperty('position') && data.position && (data.position.length == 2)) {
                        pos_x = data.position[0].toFixed(0);
                        pos_y = data.position[1].toFixed(0);
                    }

                    consoleWPI.clear();
                    consoleWPI.add_message('user', 'Загрузка системы навигации.');
                    consoleWPI.add_message(
                        'system',
                        'Успешно.\n' +
                        '-----------------------------\n' +
                        'Добро пожаловать, ' + data.user_name + '!\n' +
                        'Ваш баланс: ' + data.user_balance + ' нукойнов\n' +
                        'Ваши координаты: x' + pos_x + ':y' + pos_y + '\n' +
                        'Ваша страховка: _\n' +
                        'Активных заданий: _\n' +
                        '-----------------------------'
                    );

                    $('#RDSitePersonalInfoUserInfo').empty();
                    $('#RDSitePersonalInfoUserCar').empty();
                    $('#RDSitePersonalInfoUserInfo').append(data.user_info_html);
                    $('#RDSitePersonalInfoUserCar').append(data.user_car_html);
                }


                if (registration_status == 'chip') {
                    var ordinal_number = 1000000000 + data.ordinal_number;
                    ordinal_number = ordinal_number.toString();
                    ordinal_number = ordinal_number.substr(1, ordinal_number.length);

                    var d = new Date(data.created);
                    d.setFullYear(d.getFullYear() + 100);

                    $('#RDSiteWReg3_OrdinalNumber').text(ordinal_number);
                    $('#RDSiteWReg3_Created').text(d.toLocaleDateString());

                    $('#RDSiteWReg3_Nickname').text(data.user_name);

                    var procent_length = 20 + 2 * data.user_name.length;
                    procent_length = procent_length > 80 ? 80 : procent_length;
                    $('#RDSiteWReg3_Nickname').parent().width(procent_length + '%');

                    $('#RDSiteWReg3_UserBalance').text(data.user_balance);

                    // todo: считать перки и навыки
                }

                 // Переход на следующую страницу
                if (window.location.hash == '#start')
                    $('#RDbtn_start').click();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('Error GetUserInfo');
            }
        });
    }

    function GetRPGInfo() {
         $.ajax({
            url: location.protocol + '//' + location.host + '/site_api/get_rpg_info',
            method: 'POST',
            data: {},
            success: function(data) {
                console.log(data)
            }
        });
    }

    function RegisterBtnClick() {
        var email = document.getElementById('reg_email').value;
        var password = document.getElementById('reg_password').value;
        $.ajax({
            url: location.protocol + '//' + location.host + '/login',
            method: 'POST',
            data: {
                email: email,
                password: password,
                action: 'reg'
            },
            success: function(data) {
                consoleWReg.add_message('user', ' Активация процедуры регистрации.');
                if (data.status == 'success') {
                    consoleWReg.add_message('system', 'Успешно.');
                    GetUserInfo();
                    return;
                }
                audioManager.play('error_' + Math.floor(Math.random() * 1.99));
                if (data.status == 'fail_wrong_input') {
                    consoleWReg.add_message('system',
                            'Ошибка приема данных.\n\n' +
                            'Введена некорректная электронная почта или некорректный пароль.\n\n' +
                            '--------------------------------------------------------------\n' +
                            'Введите адрес действительной электронной почты.\n' +
                            'Введите пароль, соответствующий формату ввода системы.\n' +
                            '--------------------------------------------------------------');
                }
                if (data.status == 'fail_exist_email') {
                    consoleWReg.add_message('system',
                            'Ошибка приема данных.\n\n' +
                            'Пользователь с таким email уже зарегистрирован.');
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                consoleWReg.add_message('user', ' Активация процедуры регистрации.');
                consoleWReg.add_message('system', 'Система не отвечает. Повторите попытку позже.');
                audioManager.play('error_' + Math.floor(Math.random() * 1.99));
            }
        });
    }

    function AuthorisationBtnClick() {
        var email = document.getElementById('auth_email').value;
        var password = document.getElementById('auth_password').value;
        $.ajax({
            url: location.protocol + '//' + location.host + '/login',
            method: 'POST',
            data: {
                email: email,
                password: password,
                action: 'auth'
            },
            success: function(data) {
                consoleWReg.add_message('user', 'Активация процедуры авторизации.');
                if (data.status == 'success') {
                    consoleWReg.add_message('system', 'Успешно.');
                    GetUserInfo();
                }
                else {
                    consoleWReg.add_message('system',
                            'Доступ запрещен. Логин или пароль введены неверно.\n\n' +
                            '--------------------------------------------------------------\n' +
                            'Проверьте правильность ввода логина и пароля, учитывайте регистр и язык ввода.\n' +
                            '--------------------------------------------------------------');
                    audioManager.play('error_1');
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                consoleWReg.add_message('user', 'Активация процедуры авторизации.');
                consoleWReg.add_message('system', 'Система не отвечает. Повторите попытку позже.');
                audioManager.play('error_0');
            }
        });
    }

    function RestorePasswordBtnClick() {
        consoleWReg.add_message('user', 'Активация процедуры восстановления доступа.');
        consoleWReg.add_message('system', 'Функция недоступна.');
        audioManager.play('error_0');
    }
</script>