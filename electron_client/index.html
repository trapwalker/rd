<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Road Dogs Online</title>
    <style>
        body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            background-color: #030f00;
        }

        .content-block {
            position: relative;
            width: 716px;
            height: 438px;
            margin: 50px auto;
        }

        .window-reg-up-btn {
            position: relative;
            cursor: pointer;
            margin: 20px auto;
            border: 2px solid #209509;
            background-color: #0d3207;
            border-radius: 1px;
            text-align: center;
            height: 35px;
            line-height: 35px;
            color: #31c811;
            width: 200px;
        }
        .window-reg-up-btn:hover {
            background-color: #16560c;
            color: #51ff00;
            border-color: #37ff10;
        }
        .window-reg-up-btn:active {
            background-color: #030f00;
            color: #00ff00;
            border-color: #008000;
        }
        .window-reg-up-btn.not-access {
            background-color: #777777;
            color: whitesmoke;
            border-color: #444444;
            pointer-events: none;
        }

    </style>

    <script> window.$ = window.jQuery = window.jquery = require('jquery'); </script>
</head>

<body>
    <div class="content-block"></div>
</body>

<script>
    var start_ping_timeout = 5000;
    var ping_timeout = 3000;
    var debug = true; // todo: Забрать из настроек клиента
    var servers_added = 0;
    var all_client_cookies = null;

    var servers = [
        {name: "localhost", address: "http://localhost", pings: [], active: false, average_ping: 0, debug: true},
        {name: "192.168.1.104", address: "http://192.168.1.104", pings: [], active: false, average_ping: 0, debug: true},
        {name: "192.168.1.105", address: "http://192.168.1.105", pings: [], active: false, average_ping: 0, debug: true},
        {name: "Road Dogs RU", address: "https://roaddogs.ru", pings: [], active: false, average_ping: 0, debug: false},
        {name: "Road Dogs Online", address: "https://roaddogs.online", pings: [], active: false, average_ping: 0, debug: false}
    ];

    // Рекурсивный зацикленный пинг серверов
    function ping_server(server) {
        // Замерять пинг до серверов
        if (server.pings.length > 10) server.pings.shift();
        var t_start = new Date().time();
        var address = server.address;
        if (address) {
            $.ajax({
                url: address + '/site_api/ping',
                method: 'GET',
                data: {},
                timeout: ping_timeout,
                success: function (data) {
                    if (server.jq_div) server.jq_div.removeClass("not-access");
                    var t_ping = new Date().time() - t_start;
                    server.active = true;
                    server.pings.push(t_ping);
                    server.average_ping = server.pings.reduce(function(a, b) {return a + b}, 0) / server.pings.length;
                    ping_server(server)
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (server.jq_div) server.jq_div.addClass("not-access");
                    server.active = false;
                    server.pings = [];
                    server.average_ping = 0;
                    ping_server(server)
                }
            });
        }
    }

    // Отображение кнопок серверов
    function show_server_list() {
        var jq_servers = $(".content-block").first();
        jq_servers.empty();

        for (var i = 0; i < servers.length; i++) {
            var server = servers[i];
            if (!server.debug || debug) {
                server.jq_div = $('<div class="window-reg-up-btn not-access" onclick="gotoSite(event)" ' +
                    'data-address="' + server.address + '">' + server.name + '</div>');
                jq_servers.append(server.jq_div);
                servers_added++;
            }
        }
        if (!servers_added)
            jq_servers.append('<div class="window-reg-up-btn">Not found servers</div>');
    }

    function check_steam(){
        // Выбор оптимального сервера (по пингу)
        function get_optimal_server() {
            var index = servers.reduce(function(acc, server, index, servers) {
                if (!server.active || (server.pings.length < 5)) return acc;
                return ((acc >= 0) && (servers[acc].average_ping < server.average_ping)) ? acc : index;
            }, -1);
            return index >= 0 ? servers[index] : null;
        }

        var current_window = require('electron').remote.getCurrentWindow();
        var ticket = current_window._ticket_steam;
        var steam_id = current_window._steam_id;

        if (ticket && steam_id) {
            // 1 - Проверить куку "steam_registration" - Она отвечает за ПЕРВУЮ авторизацию этого КЛИЕНТА через стим
            var steam_registration_cookie = null;
            for (var i = 0; i < all_client_cookies.length && !steam_registration_cookie; i++)
                if (all_client_cookies[i].name == "steam_registration_cookie")
                    steam_registration_cookie = all_client_cookies[i];
            if (steam_registration_cookie) {
                show_server_list();
                return;
            }

            // Пройти по всем серверам и поискать там аккаунт, если он 1, то редиректнуть на тот сервер, иначе выбор сервера
            // todo: спросить у всех серверов этот user_steam_id

            // Найти минимальный пинг и зарегать там пользователя
            var server = get_optimal_server();
            if (server)
                $.ajax({
                    url: server.address + '/site_api/auth/steam',
                    method: 'GET',
                    data: { ticket: ticket },
                    timeout: ping_timeout,
                    success: function (data) {
                        console.log(data);
{#                        window.location = server.address + '?mode=electron'                        #}
                    },
                    error: function (jqXHR, textStatus, errorThrown) { show_server_list() }
                });
            else
                show_server_list();





            // var querystring = require('querystring');
            // var http = require('http');
            // var fs = require('fs');
            //
            // var req_data = querystring.stringify({
            //     'ticket': ticket.ticket.toString('hex')
            // });
            //
            // var req_options = {
            //     host: 'localhost',
            //     port: '80',
            //     path: '/site_api/auth/steam',
            //     method: 'GET',
            //     headers: {
            //         'Content-Type': 'application/x-www-form-urlencoded',
            //         'Content-Length': Buffer.byteLength(req_data)
            //     }
            // };
            //
            // var post_req = http.request(req_options, function (res) {
            //     res.setEncoding('utf8');
            //     res.on('data', function (chunk) {
            //         console.log('Response: ' + chunk);
            //     });
            // });
            // // post the data
            // post_req.write(req_data);
            // post_req.end();





        } else {
            show_server_list();
        }
    }




    function gotoSite(event) {
        //var path = require('path');
        //var url = require('url');
        //require('electron').remote.getCurrentWindow().loadURL(url.format({
        //                pathname: path.join(__dirname, 'index.html'),
        //                protocol: 'file:',
        //                slashes: true
        //            }));
        //return;
        var address = $(event.target).data("address");
        if (address) {
            $(event.target).addClass("not-access");
            $.ajax({
                url: address + '?mode=test',
                method: 'GET',
                data: {},
                timeout: 5000,
                success: function (data) {
                    console.log("success: site worked:", data);
                    window.location = address + '?mode=electron';
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("error: site not worked:", jqXHR, textStatus, errorThrown);
                    setTimeout(function (args) { $(event.target).removeClass("not-access"); }, 10000);
                }
             });
        }
        else
            console.error("Not found addres: ", address);
    }

    $(document).ready(function () {
        // Запускаем пинг всех серверов
        for (var i = 0; i < servers.length; i++)
            ping_server(servers[i]);

        // Перед тем как начать попытки авторизации надо подождать чтоб собралась инфа по пингу
        setTimeout(function() {
            require('electron').remote.session.defaultSession.cookies.get({},
                function(error, cookies) {
                    all_client_cookies = cookies;
                    if (cookies.length) {
                        var address = null;
                        for (var ki = 0; ki < cookies.length && !address; ki++) {
                            var k = cookies[ki];
                            if (k.name == "server_host" && k.value) {
                                for (var i = 0; i < servers.length && !address; i++) {
                                    if (servers[i].address.indexOf(k.domain) >= 0) {
                                        // Найти хоть одну куку - юзера для этого домена
                                        for (var ui = 0; ui < cookies.length && !address; ui++) {
                                            if (cookies[ui].name == "user" && cookies[ui].domain == k.domain)
                                                address = servers[i].address;
                                        }
                                    }
                                }
                            }
                        }
                        if (address)
                            $.ajax({
                                url: address + '?mode=test',
                                method: 'GET',
                                data: {},
                                timeout: max_timeout,
                                success: function (data) {
                                    if (data == "OK")
                                        window.location = address + '?mode=electron';
                                    else
                                        check_steam();
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    check_steam();
                                }
                            });
                        else
                            check_steam();
                    }
                    else
                        check_steam();
            });
        }, start_ping_timeout);
    });
</script>

</html>


