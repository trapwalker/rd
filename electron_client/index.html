<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Road Dogs Online</title>
    <style>
        body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            background-color: #030f00;
        }

        .content-block {
            position: relative;
            width: 716px;
            height: 438px;
            margin: 50px auto;
        }

        .window-reg-up-btn {
            position: relative;
            cursor: pointer;
            margin: 20px auto;
            border: 2px solid #209509;
            background-color: #0d3207;
            border-radius: 1px;
            text-align: center;
            height: 35px;
            line-height: 35px;
            color: #31c811;
            width: 200px;
        }
        .window-reg-up-btn:hover {
            background-color: #16560c;
            color: #51ff00;
            border-color: #37ff10;
        }
        .window-reg-up-btn:active {
            background-color: #030f00;
            color: #00ff00;
            border-color: #008000;
        }
        .window-reg-up-btn.not-access {
            background-color: #777777;
            color: whitesmoke;
            border-color: #444444;
            pointer-events: none;
        }

    </style>

    <script> window.$ = window.jQuery = window.jquery = require('jquery'); </script>
</head>

<body>
    <div class="content-block"></div>
</body>

<script>

    var debug = true; // todo: Забрать из настроек клиента
    var servers_added = 0;
    var max_timeout = 3000;

    var servers = [
        {name: "192.168.1.104", address: "http://192.168.1.104", debug: true},
        {name: "192.168.1.105", address: "http://192.168.1.105", debug: true},
        {name: "Road Dogs RU", address: "https://roaddogs.ru", debug: false},
        {name: "Road Dogs Online", address: "https://roaddogs.online", debug: false}
    ];


    function ping_server(server) {
        // todo: Замерять пинг до серверов
        var address = server.address;
        if (address) {
            $.ajax({
                url: address + '?mode=test',
                method: 'GET',
                data: {},
                timeout: max_timeout,
                success: function (data) {
                    if (data != "OK") return;
                    if (server.jq_div) server.jq_div.removeClass("not-access")
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (server.jq_div) server.jq_div.addClass("not-access");
                }
             });
            setTimeout(function (args) { ping_server(server) }, 10000);
        }
    }


    function show_server_list() {
        var jq_servers = $(".content-block").first();
        jq_servers.empty();

        for (var i = 0; i < servers.length; i++) {
            var server = servers[i];
            if (!server.debug || debug) {
                server.jq_div = $('<div class="window-reg-up-btn not-access" onclick="gotoSite(event)" ' +
                    'data-address="' + server.address + '">' + server.name + '</div>');
                jq_servers.append(server.jq_div);

                servers_added++;
                ping_server(server);
            }
        }
        if (!servers_added)
            jq_servers.append('<div class="window-reg-up-btn">Not found servers</div>');
    }


    $(document).ready(function () {
        require('electron').remote.session.defaultSession.cookies.get(
            {name: "server_host"},
            function(error, cookies) {
                if (cookies.length) {
                    var address = null;
                    for (var ki = 0; ki < cookies.length && !address; ki++) {
                        var k = cookies[ki];
                        if (k.value)
                            for (var i = 0; i < servers.length && !address; i++) {
                                if (servers[i].address.indexOf(k.domain) >= 0)
                                    address = servers[i].address;
                            }
                    }
                    if (address)
                        $.ajax({
                            url: address + '?mode=test',
                            method: 'GET',
                            data: {},
                            timeout: max_timeout,
                            success: function (data) {
                                if (data == "OK") {
                                    require('electron').remote.session.defaultSession.cookies.get(
                                        {name: "user"},
                                        function (error, cookies) {
                                            if(cookies.length)
                                                window.location = address + '?mode=electron';
                                            else
                                                show_server_list();
                                        });
                                }
                                else
                                    show_server_list();
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                show_server_list();
                            }
                        });
                    else
                        show_server_list();
                }
                else
                    show_server_list();
            });
    });


    function gotoSite(event) {
        //var path = require('path');
        //var url = require('url');
        //require('electron').remote.getCurrentWindow().loadURL(url.format({
        //                pathname: path.join(__dirname, 'index.html'),
        //                protocol: 'file:',
        //                slashes: true
        //            }));
        //return;
        var address = $(event.target).data("address");
        if (address) {
            $(event.target).addClass("not-access");
            $.ajax({
                url: address + '?mode=test',
                method: 'GET',
                data: {},
                timeout: 5000,
                success: function (data) {
                    console.log("success: site worked:", data);
                    window.location = address + '?mode=electron';
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("error: site not worked:", jqXHR, textStatus, errorThrown);
                    setTimeout(function (args) { $(event.target).removeClass("not-access"); }, 10000);
                }
             });
        }
        else
            console.error("Not found addres: ", address);
    }
</script>

</html>


